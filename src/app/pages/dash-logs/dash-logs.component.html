<div class="dashlogs-container">
  <h2>Dashboard de Logs</h2>

  <div *ngIf="summary">
    <div class="summary-cards">
      <div class="card highlight">Total logs: <b>{{ summary.total_logs }}</b></div>
      <div class="card">Promedio Response Time: <b>{{ avgResponseSeconds }} s</b></div>
      <div class="card">API más rápida: <b>{{ fastestApi }}</b></div>
      <div class="card">API más lenta: <b>{{ slowestApi }}</b></div>
      <div class="card">API más consumida: <b>{{ mostUsedApi }}</b></div>
      <div class="card">API menos consumida: <b>{{ leastUsedApi }}</b></div>
    </div>

    <div class="charts-row">
      <div class="chart-box chart-box-wide">
        <h4>Status de Respuestas</h4>
        <div class="status-legend" style="margin-bottom: 1rem;">
          <b>Significado de códigos de estado:</b>
          <ul class="status-codes-legend">
            <li><b>200</b>: Exitoso</li>
            <li><b>201</b>: Creado</li>
            <li><b>400</b>: Solicitud incorrecta</li>
            <li><b>401</b>: No autorizado</li>
            <li><b>404</b>: No encontrado</li>
            <li><b>500</b>: Error interno</li>
            <li><b>502</b>: Bad Gateway</li>
            <li><b>308</b>: Otro (redirect permanente)</li>
            <li><b>405</b>: Otro (método no permitido)</li>
          </ul>
        </div>
        <div style="width: 100%; min-width: 700px; max-width: 1200px; height: 420px; margin: 0 auto;">
          <canvas baseChart
            [data]="statusChartData"
            [type]="statusChartType"
            [options]="{responsive: true, maintainAspectRatio: false}"
            style="height: 400px; width: 100%; display: block;">
          </canvas>
        </div>
      </div>
    </div>


    <div class="api-table-container">
      <h4>Logs históricos del sistema</h4>
      <div class="log-filters">
        <div class="filter-group">
          <label for="apiFilter">API</label>
          <select id="apiFilter" [(ngModel)]="filterApi">
            <option value="">Todas</option>
            <option *ngFor="let api of apiOptions" [value]="api">{{ api }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="statusFilter">Status</label>
          <select id="statusFilter" [(ngModel)]="filterStatus">
            <option value="">Todos</option>
            <option *ngFor="let status of statusOptions" [value]="status">{{ status }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="descFilter">Descripción</label>
          <input id="descFilter" type="text" [(ngModel)]="filterDescription" placeholder="Buscar..." />
        </div>
        <div class="filter-group">
          <label for="dateFrom">Desde</label>
          <input id="dateFrom" type="date" [(ngModel)]="filterDateFrom" />
        </div>
        <div class="filter-group">
          <label for="dateTo">Hasta</label>
          <input id="dateTo" type="date" [(ngModel)]="filterDateTo" />
        </div>
      </div>
      <div class="table-responsive">
        <table class="api-table">
          <thead>
            <tr>
              <th (click)="setSort('timestamp')">Fecha {{ sortIndicator('timestamp') }}</th>
              <th (click)="setSort('api_name')">API {{ sortIndicator('api_name') }}</th>
              <th (click)="setSort('method')">Método {{ sortIndicator('method') }}</th>
              <th (click)="setSort('path')">Path {{ sortIndicator('path') }}</th>
              <th (click)="setSort('status_code')">Status {{ sortIndicator('status_code') }}</th>
              <th>Descripción</th>
              <th (click)="setSort('duration_ms')">Duración (s) {{ sortIndicator('duration_ms') }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let log of filteredLogs">
              <td>{{ log.timestamp | date:'yyyy-MM-dd HH:mm:ss':'UTC' }}</td>
              <td>{{ log.api_name }}</td>
              <td>{{ log.method }}</td>
              <td>{{ log.path }}</td>
              <td>{{ log.status_code }}</td>
              <td>{{ statusDescriptions[log.status_code?.toString()] || 'Otro' }}</td>
              <td>{{ (log.duration_ms || 0) / 1000 | number:'1.3-3' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div *ngIf="!summary">
    <p>Cargando datos...</p>
  </div>
</div>
